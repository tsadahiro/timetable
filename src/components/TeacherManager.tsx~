import { useEffect, useState } from "react";
import {
  Box,
  Button,
  Dialog,
  DialogActions,
  DialogContent,
  DialogTitle,
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableRow,
  Typography,
  TextField,
} from "@mui/material";
import { supabase } from "../lib/supabaseClient";

type Teacher = {
  id: number;
  fname: string;   // å§“
  gname: string;   // å
  yomi: string;    // å§“ã®ã‚ˆã¿ï¼ˆã‚½ãƒ¼ãƒˆç”¨ï¼‰
  jyokin: boolean; // å¸¸å‹¤ãƒ•ãƒ©ã‚°
};

type Jugyo = {
  id: number;
  year: number;
  period: number;
  wdays: { name: string };
  kamokus: { name: string };
};

export default function TeacherManager({ year }: { year: number }) {
  const [teachers, setTeachers] = useState<Teacher[]>([]);
  const [openDialog, setOpenDialog] = useState(false);
  const [selectedTeacher, setSelectedTeacher] = useState<Teacher | null>(null);
  const [jugyos, setJugyos] = useState<Jugyo[]>([]);
  const [addOpen, setAddOpen] = useState(false);
  const [newTeacher, setNewTeacher] = useState({
    fname: "",
    gname: "",
    yomi: "",
    jyokin: true,
  });

  // ğŸ”¹ æ•™å“¡ãƒªã‚¹ãƒˆå–å¾—
  const fetchTeachers = async () => {
    const { data, error } = await supabase
      .from("teachers")
      .select("*")
      .order("jyokin", { ascending: false }) // å¸¸å‹¤(true)â†’éå¸¸å‹¤(false)
      .order("yomi", { ascending: true });
    if (error) console.error(error);
    else setTeachers(data || []);
  };

  useEffect(() => {
    fetchTeachers();
  }, []);

  // ğŸ”¹ æ•™å“¡ã‚¯ãƒªãƒƒã‚¯æ™‚ï¼šæ‹…å½“æˆæ¥­ã‚’å–å¾—
  const handleOpenTeacher = async (teacher: Teacher) => {
    setSelectedTeacher(teacher);
    const { data, error } = await supabase
      .from("jugyos")
      .select("id, year, period, wdays(name), kamokus(name)")
      .eq("teacher_id", teacher.id)
      .eq("year", year)
      .order("wday_id", { ascending: true })
      .order("period", { ascending: true });

    if (error) console.error(error);
    else setJugyos(data || []);

    setOpenDialog(true);
  };

  // ğŸ”¹ æ•™å“¡è¿½åŠ 
  const handleAddTeacher = async () => {
    const { error } = await supabase.from("teachers").insert([newTeacher]);
    if (error) {
      alert("ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ");
      console.error(error);
      return;
    }
    setAddOpen(false);
    setNewTeacher({ fname: "", gname: "", yomi: "", jyokin: true });
    fetchTeachers();
  };

  return (
    <Box sx={{ p: 3 }}>
      <Typography variant="h5" gutterBottom>
        æ•™å“¡ä¸€è¦§
      </Typography>

      {/* æ–°è¦è¿½åŠ ãƒœã‚¿ãƒ³ */}
      <Box sx={{ mb: 2 }}>
        <Button variant="contained" onClick={() => setAddOpen(true)}>
          æ–°è¦è¿½åŠ 
        </Button>
      </Box>

      {/* æ•™å“¡ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« */}
      <Table size="small">
        <TableHead>
          <TableRow>
            <TableCell>ID</TableCell>
            <TableCell>æ°å</TableCell>
            <TableCell>ã‚ˆã¿</TableCell>
            <TableCell>å¸¸å‹¤</TableCell>
          </TableRow>
        </TableHead>
        <TableBody>
          {teachers.map((t) => (
            <TableRow
              key={t.id}
              hover
              sx={{ cursor: "pointer" }}
              onClick={() => handleOpenTeacher(t)}
            >
              <TableCell>{t.id}</TableCell>
              <TableCell>{`${t.fname} ${t.gname}`}</TableCell>
              <TableCell>{t.yomi}</TableCell>
              <TableCell>{t.jyokin ? "å¸¸å‹¤" : "éå¸¸å‹¤"}</TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>

      {/* æ‹…å½“æˆæ¥­ãƒ€ã‚¤ã‚¢ãƒ­ã‚° */}
      <Dialog
        open={openDialog}
        onClose={() => setOpenDialog(false)}
        fullWidth
        maxWidth="sm"
      >
        <DialogTitle>
          {selectedTeacher
            ? `${selectedTeacher.fname} ${selectedTeacher.gname} ã®æ‹…å½“æˆæ¥­ï¼ˆ${year}å¹´åº¦ï¼‰`
            : "æ‹…å½“æˆæ¥­"}
        </DialogTitle>
        <DialogContent dividers>
          {jugyos.length === 0 ? (
            <Typography>è©²å½“æˆæ¥­ãªã—</Typography>
          ) : (
            <Table size="small">
              <TableHead>
                <TableRow>
                  <TableCell>ç§‘ç›®</TableCell>
                  <TableCell>æ›œæ—¥</TableCell>
                  <TableCell>æ™‚é™</TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {jugyos.map((j) => (
                  <TableRow key={j.id}>
                    <TableCell>{j.kamokus.name}</TableCell>
                    <TableCell>{j.wdays.name}</TableCell>
                    <TableCell>{j.period}</TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          )}
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setOpenDialog(false)}>é–‰ã˜ã‚‹</Button>
        </DialogActions>
      </Dialog>

      {/* æ•™å“¡è¿½åŠ ãƒ€ã‚¤ã‚¢ãƒ­ã‚° */}
      <Dialog open={addOpen} onClose={() => setAddOpen(false)}>
        <DialogTitle>æ–°è¦æ•™å“¡ã®ç™»éŒ²</DialogTitle>
        <DialogContent>
          <TextField
            margin="dense"
            label="å§“"
            fullWidth
            value={newTeacher.fname}
            onChange={(e) =>
              setNewTeacher({ ...newTeacher, fname: e.target.value })
            }
          />
          <TextField
            margin="dense"
            label="å"
            fullWidth
            value={newTeacher.gname}
            onChange={(e) =>
              setNewTeacher({ ...newTeacher, gname: e.target.value })
            }
          />
          <TextField
            margin="dense"
            label="ã‚ˆã¿ï¼ˆå§“ï¼‰"
            fullWidth
            value={newTeacher.yomi}
            onChange={(e) =>
              setNewTeacher({ ...newTeacher, yomi: e.target.value })
            }
          />
          <TextField
            select
            margin="dense"
            label="å¸¸å‹¤ / éå¸¸å‹¤"
            fullWidth
            value={newTeacher.jyokin ? "true" : "false"}
            onChange={(e) =>
              setNewTeacher({
                ...newTeacher,
                jyokin: e.target.value === "true",
              })
            }
            SelectProps={{ native: true }}
          >
            <option value="true">å¸¸å‹¤</option>
            <option value="false">éå¸¸å‹¤</option>
          </TextField>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setAddOpen(false)}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</Button>
          <Button variant="contained" onClick={handleAddTeacher}>
            ç™»éŒ²
          </Button>
        </DialogActions>
      </Dialog>
    </Box>
  );
}
